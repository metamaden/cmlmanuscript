---
title: "exclusionbias"
author: "SKM"
date: "12/9/2019"
output: html_document
---

```{r docprep, eval = TRUE, echo = TRUE}
library(cmlmanuscript)
load(dataprep.Rdata)
```

We performed ablation tests to assess the impact of exclusion bias. Feature exclusion bias reflects the fact that feature assessment, and ultimate exlcusion or exclusion from penalized regression, is biased by inclusion or exclusion of other features. We showed this bias through ablation of penalized regression runs, using three penalization schema (lasso, ridge regression, and elastic net).

# Ablation tests

To perform ablation tests, we performed penalized regression with one of three penalization strategies (lasso, ridge regression, or elastic net). We initially fitted a model with the chosen schema. In subsequent reps, we excluded features with the largest coefficients, or any features with nonzero coefficients for lasso, and repeated penalized regression.

## Lasso

```{r lassoreps, warning=FALSE}
ptype = "lasso"
lexclude = list()
lrep = list()
for(i in 1:15){
  if(i == 1){
    lrep[[i]] = runLasso(seset = degfilt.se)
  } else{
    lrep[[i]] = runLasso(seset=degfilt.se[!rownames(degfilt.se) %in% unlist(lexclude),])
  }
  lexclude[[i]] = names(lrep[[i]]$nonzero.coef)
  message("finished ", ptype," rep ", i)
}
```

## Ridge regression

Because ridge regression does not eliminate features by assignment of 0 coefficients, we removed genes with the top 5th quantile absolute importance (coefficient magnitude) between repetitions.

```{r ridgereps, warning=FALSE}
ptype = "ridge regression"
qimpfilt = 5
lexclude = list()
lrep = list()
for(i in 1:15){
  if(i == 1){
    lrep[[i]] = runRidge(seset = degfilt.se)
  } else{
    lrep[[i]] = runRidge(seset = degfilt.se[!rownames(degfilt.se) %in% unlist(lexclude),])
  }
  coeffi = lrep[[i]]$nonzero.coef
  qcoeffilt = quantile(abs(coeffi), seq(0, 1, 0.05))[20]
  lexclude[[i]] = names(coeffi[coeffi>=qcoeffilt])
  message("finished ", ptype," rep ", i)
}
```

## Elastic net 

Similar to lasso ablation tests, we excluded features with nonzero coefficients between repetitions of elastic net repetitions.

```{r enetreps, warning=FALSE}
ptype = "elastic net"
qimpfilt = 5
lexclude = list()
lrep = list()
for(i in 1:15){
  if(i == 1){
    lrep[[i]] = runEnet(seset = degfilt.se)
  } else{
    lrep[[i]] = runEnet(seset = degfilt.se[!rownames(degfilt.se) %in% unlist(lexclude),])
  }
  lexclude[[i]] = names(lrep[[i]]$nonzero.coef)
  message("finished ", ptype," rep ", i)
}
```
